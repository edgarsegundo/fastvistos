---
/**
 * CarouselSection.astro
 * Dynamic carousel for topics and articles
 * Usage: <CarouselSection topicsWithArticles={topicsWithArticles} />
 */

import { BlogService } from "../lib/blog-service.ts";

const limitPerTopic = 6;

// Fetch topics with articles dynamically
const topicsWithArticles = await BlogService.getTopicsWithArticles(limitPerTopic);

// Get businessId from siteConfig (Astro server)
import { siteConfig } from '../site-config.ts';
const businessId = siteConfig.site.business_id;
---

<style>
  .carousel-container::-webkit-scrollbar { display: none; }
  .carousel-container { -ms-overflow-style: none; scrollbar-width: none; scroll-behavior: smooth; }
  .carousel-arrow-bar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: -0.5rem;
    gap: 0.5rem;
  }
  .arrow-btn-subtle {
    background: none;
    border: 1px solid #d1d5db; /* Tailwind gray-300 */
    color: #6b7280; /* Tailwind gray-500 */
    width: 28px;
    height: 28px;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    opacity: 0.6;
  }
  .arrow-btn-subtle:hover {
    border-color: #111; /* Tailwind blue-600 */
    opacity: .7;
  }
  .carousel-fade-right {
    position: absolute;
    top: 10px;
    right: 0;
    width: 64px;
    height: 100%;
    pointer-events: none;
    background: linear-gradient(to left, rgba(0,0,0,0.10) 60%, rgba(255,255,255,0));
    z-index: 10;
    opacity: 1;
    transition: opacity 0.2s;
  }
  .carousel-fade-right.hide {
    opacity: 0;
  }
</style>

<section class="w-full">
  {
    topicsWithArticles.length > 0 ? (
      topicsWithArticles.map((topic) => (
        <div class="relative mt-12 w-full">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 id={topic.slug || topic.id} class="text-3xl font-semibold mb-8 text-black">
              {topic.title}
            </h2>

            <!-- Arrow bar above carousel -->
            <div class="carousel-arrow-bar">
              <button class="arrow-btn-subtle" aria-label="Scroll left" onclick={`document.querySelector('#carousel-${topic.slug || topic.id}').scrollBy({left:-320, behavior:'smooth'})`}>
                &#10094;
              </button>
              <button class="arrow-btn-subtle" aria-label="Scroll right" onclick={`document.querySelector('#carousel-${topic.slug || topic.id}').scrollBy({left:320, behavior:'smooth'})`}>
                &#10095;
              </button>
            </div>

            <div class="relative pt-2">
              <div
                id={`carousel-${topic.slug || topic.id}`}
                data-topic-id={topic.id}
                class="carousel-container flex gap-6 overflow-x-auto pb-4 pt-4 px-4"
              >
                {topic.blog_article.map((article) => (
                  <a href={`/blog/${article.slug}`}
                     class="bg-white transition-all duration-300 flex-shrink-0 w-80 shadow-none hover:scale-105 rounded-none cursor-pointer block"
                     style="text-decoration: none;"
                  >
                    <img
                      src={
                        article.image
                          ? `/assets/images/blog/${article.image.replace(/^.*\//, "")}`
                          : "https://via.placeholder.com/400x250"
                      }
                      alt={article.slug || article.title}
                      class="w-full aspect-[1.67] object-cover"
                    />

                    <div class="p-6">
                      <h3 class="text-xl font-semibold mb-2 text-black">
                        {article.title.length > 70
                          ? article.title.slice(0, 70) + "..."
                          : article.title}
                      </h3>

                      <p class="text-gray-600 mb-4">
                        {article.content_html
                          ? article.content_html.replace(/<[^>]*>/g, "").slice(0, 150) + "..."
                          : ""}
                      </p>
                    </div>
                  </a>
                ))}
              </div>

              <div class="carousel-fade-right"></div>
            </div>
          </div>
        </div>
      ))
    ) : (
      <div class="text-center py-12">
        <p class="text-gray-600 text-lg">Nenhum artigo encontrado.</p>
        <p class="text-gray-500 mt-2">Volte em breve para conferir nossos artigos!</p>
      </div>
    )
  }

</section>


<script define:vars={{ businessId }}>
  window.__BUSINESS_ID__ = businessId;
</script>


<script>
// Configurable batch size
const BATCH_SIZE = 5;

// Real endpoint: returns next articles for a topic
async function fetchNextArticles(topicId, offset, limit) {
  const businessId = window.__BUSINESS_ID__;
  const url = `https://p2digital.com.br/msitesapp/api/next-articles?business_id=${encodeURIComponent(businessId)}&blog_topic_id=${encodeURIComponent(topicId)}&offset=${offset}&limit=${limit}`;
  try {
    const res = await fetch(url);
    if (!res.ok) return [];
    const data = await res.json();
    // Map to expected card fields
    return (data.articles || []).map(a => ({
      slug: a.slug,
      title: a.title,
      image: a.image || '',
      content_html: a.seo_description || '',
    }));
  } catch (err) {
    return [];
  }
}

// Spinner SVG
const spinnerSVG = `<svg class='spinner' width='32' height='32' viewBox='0 0 32 32'><circle cx='16' cy='16' r='14' stroke='#2563eb' stroke-width='4' fill='none' opacity='0.2'/><circle cx='16' cy='16' r='14' stroke='#2563eb' stroke-width='4' fill='none' stroke-dasharray='22 88' stroke-linecap='round'><animateTransform attributeName='transform' type='rotate' from='0 16 16' to='360 16 16' dur='0.8s' repeatCount='indefinite'/></circle></svg>`;

// State: loaded articles per topic
const topicStates = {};
var offset = BATCH_SIZE;

document.querySelectorAll('.carousel-container').forEach((carousel, topicIdx) => {
    const topicId = carousel.id.replace('carousel-', '');
    topicStates[topicId] = {
        loading: false,
        offset: carousel.children.length - 1, // initial loaded
        done: false,
        topicId: carousel.getAttribute('data-topic-id')
    };

    // Helper: show spinner in empty image cards
    function showSpinners() {
        carousel.querySelectorAll('a').forEach(card => {
            const img = card.querySelector('img');
            if (img && !img.src) {
                img.outerHTML = `<div style='display:flex;align-items:center;justify-content:center;height:100%;'>${spinnerSVG}</div>`;
            }
        });
    }

    // Fade logic: show fade only when not at end
    const fade = carousel.parentElement.querySelector('.carousel-fade-right');
    function updateFade() {
        const maxScroll = carousel.scrollWidth - carousel.clientWidth;
        if (carousel.scrollLeft >= maxScroll - 2) {
            if (fade) fade.classList.add('hide');
        } else {
            if (fade) fade.classList.remove('hide');
        }
    }
    carousel.addEventListener('scroll', updateFade);
    setTimeout(updateFade, 100);

    // Prevent wheel scroll past the end
    carousel.addEventListener('wheel', (e) => {
    const event = e as WheelEvent;
    const maxScroll = carousel.scrollWidth - carousel.clientWidth;
    if ((carousel.scrollLeft === 0 && event.deltaX < 0) || (carousel.scrollLeft === maxScroll && event.deltaX > 0)) {
        event.preventDefault();
    }
    }, { passive: false });

    // Load more articles when scrolled to end
    carousel.addEventListener('scroll', async () => {
        const maxScroll = carousel.scrollWidth - carousel.clientWidth;
        if (carousel.scrollLeft >= maxScroll - 2 && !topicStates[topicId].loading && !topicStates[topicId].done) {
            topicStates[topicId].loading = true;
            // Add spinner cards
            for (let i = 0; i < BATCH_SIZE; i++) {
                const spinnerCard = document.createElement('a');
                spinnerCard.className = "bg-white transition-all duration-300 flex-shrink-0 w-80 shadow-none hover:scale-105 rounded-none cursor-pointer block";
                spinnerCard.style.textDecoration = "none";
                spinnerCard.innerHTML = `<div style='height:192px;width:100%;display:flex;align-items:center;justify-content:center;'>${spinnerSVG}</div><div class='p-6'></div>`;
                carousel.appendChild(spinnerCard);
            }
            // Fetch next articles
            const nextArticles = await fetchNextArticles(topicStates[topicId].topicId, topicStates[topicId].offset, BATCH_SIZE);
            // Remove spinner cards
            for (let i = 0; i < BATCH_SIZE; i++) {
                carousel.removeChild(carousel.lastChild);
            }
            if (nextArticles.length === 0) {
                topicStates[topicId].done = true;
            } else {
                nextArticles.forEach(article => {
                    const card = document.createElement('a');
                    card.href = `/blog/${article.slug}`;
                    card.className = "bg-white transition-all duration-300 flex-shrink-0 w-80 shadow-none hover:scale-105 rounded-none cursor-pointer block";
                    card.style.textDecoration = "none";
                    const imgSrc = article.image
                        ? `/assets/images/blog/${article.image.replace(/^.*\//, '')}`
                        : "https://via.placeholder.com/400x250";
                    card.innerHTML = `
                    <img src='${imgSrc}' alt='${article.slug}' class='w-full aspect-[1.67] object-cover' />
                    <div class='p-6'>
                        <h3 class='text-xl font-semibold mb-2 text-black'>${article.title}</h3>
                        <p class='text-gray-600 mb-4'>${article.content_html}</p>
                    </div>
                    `;
                    carousel.appendChild(card);
                });
                topicStates[topicId].offset += nextArticles.length;
                showSpinners();
            }
            topicStates[topicId].loading = false;
        }
    });
});
</script>
