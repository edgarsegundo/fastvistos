---
/**
 * CarouselSection.astro
 * Dynamic carousel for topics and articles
 * Usage: <CarouselSection topicsWithArticles={topicsWithArticles} />
 */

import { BlogService } from "../lib/blog-service.ts";

// Fetch topics with articles dynamically
const topicsWithArticles = await BlogService.getTopicsWithArticles();
---

<style>
  .carousel-container::-webkit-scrollbar { display: none; }
  .carousel-container { -ms-overflow-style: none; scrollbar-width: none; scroll-behavior: smooth; }
  .carousel-arrow-bar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: -0.5rem;
    gap: 0.5rem;
  }
  .arrow-btn-subtle {
    background: none;
    border: 1px solid #d1d5db; /* Tailwind gray-300 */
    color: #6b7280; /* Tailwind gray-500 */
    width: 28px;
    height: 28px;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    opacity: 0.6;
  }
  .arrow-btn-subtle:hover {
    border-color: #111; /* Tailwind blue-600 */
    opacity: .7;
  }
  .carousel-fade-right {
    position: absolute;
    top: 10px;
    right: 0;
    width: 64px;
    height: 100%;
    pointer-events: none;
    background: linear-gradient(to left, rgba(0,0,0,0.10) 60%, rgba(255,255,255,0));
    z-index: 10;
    opacity: 1;
    transition: opacity 0.2s;
  }
  .carousel-fade-right.hide {
    opacity: 0;
  }
</style>

<section class="w-full">
  {
    topicsWithArticles.length > 0 ? (
      topicsWithArticles.map((topic) => (
        <div class="relative mt-12 w-full">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 id={topic.slug || topic.id} class="text-3xl font-semibold mb-8 text-black">
              {topic.title}
            </h2>

            <!-- Arrow bar above carousel -->
            <div class="carousel-arrow-bar">
              <button class="arrow-btn-subtle" aria-label="Scroll left" onclick={`document.querySelector('#carousel-${topic.slug || topic.id}').scrollBy({left:-320, behavior:'smooth'})`}>
                &#10094;
              </button>
              <button class="arrow-btn-subtle" aria-label="Scroll right" onclick={`document.querySelector('#carousel-${topic.slug || topic.id}').scrollBy({left:320, behavior:'smooth'})`}>
                &#10095;
              </button>
            </div>

            <div class="relative pt-2">
              <div
                id={`carousel-${topic.slug || topic.id}`}
                class="carousel-container flex gap-6 overflow-x-auto pb-4 pt-4 px-4"
              >
                {topic.blog_article.map((article) => (
                  <a href={`/blog/${article.slug}`}
                     class="bg-white transition-all duration-300 flex-shrink-0 w-80 shadow-none hover:scale-105 rounded-none cursor-pointer block"
                     style="text-decoration: none;"
                  >
                    <img
                      src={
                        article.image
                          ? `/assets/images/blog/${article.image.replace(/^.*\//, "")}`
                          : "https://via.placeholder.com/400x250"
                      }
                      alt={article.slug || article.title}
                      class="w-full aspect-[1.67] object-cover"
                    />

                    <div class="p-6">
                      <h3 class="text-xl font-semibold mb-2 text-black">
                        {article.title.length > 70
                          ? article.title.slice(0, 70) + "..."
                          : article.title}
                      </h3>

                      <p class="text-gray-600 mb-4">
                        {article.content_html
                          ? article.content_html.replace(/<[^>]*>/g, "").slice(0, 150) + "..."
                          : ""}
                      </p>
                    </div>
                  </a>
                ))}
              </div>

              <div class="carousel-fade-right"></div>
            </div>
          </div>
        </div>
      ))
    ) : (
      <div class="text-center py-12">
        <p class="text-gray-600 text-lg">Nenhum artigo encontrado.</p>
        <p class="text-gray-500 mt-2">Volte em breve para conferir nossos artigos!</p>
      </div>
    )
  }

  <script>
    const carousels = document.querySelectorAll('.carousel-container');
    const scrollAmount = 320;

    carousels.forEach((carousel) => {
      const fade = carousel.parentElement.querySelector('.carousel-fade-right');
      function updateFade() {
        const maxScroll = carousel.scrollWidth - carousel.clientWidth;
        if (carousel.scrollLeft >= maxScroll - 2) {
          if (fade) fade.classList.remove('hide');
        } else {
          if (fade) fade.classList.add('hide');
        }
      }
      carousel.addEventListener('scroll', updateFade);
      setTimeout(updateFade, 50); // Initial state

      document.addEventListener('keydown', (e) => {
        const rect = carousel.getBoundingClientRect();
        const isInView = rect.top >= 0 && rect.bottom <= window.innerHeight;

        if (isInView) {
          if (e.key === 'ArrowLeft') {
            carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
          } else if (e.key === 'ArrowRight') {
            carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
          }
        }
      });

      let startX = 0;
      let scrollStart = 0;

      carousel.addEventListener('touchstart', (e) => {
        const touchEvent = e as TouchEvent;
        startX = touchEvent.touches[0].clientX;
        scrollStart = carousel.scrollLeft;
      });

      carousel.addEventListener('touchmove', (e) => {
        const touchEvent = e as TouchEvent;
        if (!startX) return;
        const currentX = touchEvent.touches[0].clientX;
        const diff = startX - currentX;
        // Prevent scrolling past the end
        const maxScroll = carousel.scrollWidth - carousel.clientWidth;
        let newScroll = scrollStart + diff;
        if (newScroll < 0) newScroll = 0;
        if (newScroll > maxScroll) newScroll = maxScroll;
        carousel.scrollLeft = newScroll;
      });

      carousel.addEventListener('touchend', () => {
        startX = 0;
        scrollStart = 0;
      });

      // Prevent wheel scroll past the end
      carousel.addEventListener('wheel', (e) => {
        const event = e as WheelEvent;
        const maxScroll = carousel.scrollWidth - carousel.clientWidth;
        if ((carousel.scrollLeft === 0 && event.deltaX < 0) || (carousel.scrollLeft === maxScroll && event.deltaX > 0)) {
          event.preventDefault();
        }
      }, { passive: false });
    });
  </script>
</section>
