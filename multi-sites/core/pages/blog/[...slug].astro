---
/**
 * üö® AUTO-GENERATED FILE. DO NOT EDIT.
 * This file is generated by sync-blog.js and will be overwritten.
 * To customize, edit the template.
 */

import { getCollection } from 'astro:content';
import SharedBlogLayout from '../../layouts/SharedBlogLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import SidebarAbove from '../../components/SidebarAbove.astro';
import SidebarBelow from '../../components/SidebarBelow.astro';
import AffiliateAds from '../../components/AffiliateAds.astro';
import { siteConfig } from '../../site-config.ts';
import { BlogService } from '../../lib/blog-service.ts';
import { RelatedArticlesService } from '../../lib/related-articles.ts';
import { ContentProcessor } from '../../lib/content-processor.ts';
import { estimateReadingTime, getValidatedImageUrl } from '../../lib/utils.ts';
import JsonLdBlogPost from '../../components/JsonLdBlogPost.astro';
import { marked } from 'marked';
import '../../styles/markdown-blog.css';
import { ensureTrailingSlash } from '../../lib/utils.ts';


// Generate static paths from the markdown files in content/blog/
export async function getStaticPaths() {
    const blogEntries = await getCollection('blog');

    return blogEntries.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

// Get the markdown entry from props
const { entry } = Astro.props;

// Process HowTo tags first, then RELATED-ARTICLE tags
const rawContent = entry.body || '';
const { processedContent: contentNoHowTo, howToJson } =
    ContentProcessor.processHowToTags(rawContent);
const processedContent = await ContentProcessor.processRelatedArticleTags(contentNoHowTo);

console.log(`üõëüõë howToJson: ${JSON.stringify(howToJson)}`);

// Render the original content for headings (TOC)
const { headings } = await entry.render();

// Convert processed markdown to HTML
let processedHtml = await marked(processedContent, {
    gfm: true,
    breaks: true,
});

processedHtml = await ContentProcessor.addHeadingIds(processedHtml);

const articleFromDb = await BlogService.getArticleBySlugFromDb(entry.slug);
const blogConfigFromDb = await BlogService.getBlogConfigFromDb();
const canonical = siteConfig.site.canonical
    ? new URL(ensureTrailingSlash(siteConfig.site.canonical) + 'blog/' + entry.slug).toString()
    : undefined;

// Get author information
const authorName = articleFromDb?.author_name || blogConfigFromDb?.author_name;
const authorImage = articleFromDb?.author_image || blogConfigFromDb?.author_image;
const authorDescription = blogConfigFromDb?.author_description;

// Get FAQ information
const faqJson = articleFromDb?.faq_json;
let faqData = null;

if (faqJson) {
    try {
        faqData = typeof faqJson === 'string' ? JSON.parse(faqJson) : faqJson;
    } catch (e) {
        console.error('Error parsing FAQ JSON:', e);
    }
}

// Get related articles
let relatedArticles = [];
if (articleFromDb?.id) {
    try {
        relatedArticles = await RelatedArticlesService.getRelatedArticlesSimple(articleFromDb.id);
        console.log(`üìö Found ${relatedArticles.length} related articles`);
    } catch (e) {
        console.error('Error fetching related articles:', e);
    }
}

const authorImageUrl = authorImage
    ? '/assets/images/blog/' + authorImage.replace(/^.*\//, '')
    : null;


// No topo do script, ap√≥s const { entry } = Astro.props;
const pubDate = new Date(entry.data.pubDate);
pubDate.setHours(0, 0, 0, 0);

const updatedDate = entry.data.updatedDate ? new Date(entry.data.updatedDate) : null;
if (updatedDate) updatedDate.setHours(0, 0, 0, 0);

const showUpdatedDate = updatedDate && updatedDate > pubDate;

---

<SharedBlogLayout
    canonicalConf={canonical}
    faviconPathFromConf={siteConfig.site.faviconPath}
    seoFromConf={siteConfig.blogPostConfig.seo}
    titleFromDb={articleFromDb?.title}
    descriptionFromDb={articleFromDb?.seo_description}
    authorNameFromDb={articleFromDb?.author_name}
    imageFromDb={articleFromDb?.image}
    imageUrlFromDb={articleFromDb?.seo_image_url}
    imageCaptionFromDb={articleFromDb?.seo_image_caption}
    imageWidthFromDb={articleFromDb?.seo_image_width}
    imageHeightFromDb={articleFromDb?.seo_image_height}
    pubDate={articleFromDb?.published ? new Date(articleFromDb.published).toISOString() : undefined}
    updatedDate={articleFromDb?.modified
        ? new Date(articleFromDb.modified).toISOString()
        : undefined}
>
    
    <Fragment slot="head">
        <!-- <link rel="stylesheet" href="/shared.css" /> -->
        <JsonLdBlogPost
            articleConfigFromDb={articleFromDb}
            blogConfigFromDb={blogConfigFromDb}
            pubDate={entry.data.pubDate}
            updatedDate={entry.data.updatedDate}
            wordCount={entry.data.wordCount}
            howToLdJson={howToJson}
        />
    </Fragment>

    <!-- Article -->
    <main class="w-full px-4 sm:px-6 lg:px-42 pt-12 mt-16">

        <!-- Breadcrumb -->
        <nav class="text-sm text-textSecondary mb-6">
            <span>
                <a
                    href={siteConfig.site.canonical}
                    class=""
                    >Home</a
                >                
            </span>
            <span class="mx-2">‚Ä∫</span>
            <span>
                <a
                    href="/blog"
                    class=""
                    >Blog</a
                >
            </span>
            <span class="mx-2">‚Ä∫</span>
            <span class="font-small text-[#6b6f76] opacity-80">
                {entry.data.title}
            </span>
        </nav>

        <!-- Title -->
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-semibold leading-tight mb-8 max-w-5xl">
            {entry.data.title}
        </h1>

        <!-- Subtitle -->
        <p class="text-lg sm:text-xl text-textSecondary mb-10 max-w-3xl">
            {entry.data.description && entry.data.description}
        </p>

        <!-- Category -->
        <span class="inline-block text-sm font-medium mb-10">
            {entry.data.topic && <span class="article-topic">{entry.data.topic}</span>}
        </span>

        <!-- Meta -->
        <div class="flex flex-wrap items-center gap-4 text-sm text-textSecondary mb-12">
            <div class="flex items-center gap-1">
                <span>‚è±</span>
                <span>{estimateReadingTime(Number(entry.data.wordCount))} minutos de leitura</span>
            </div>

            {authorName && authorName.trim() !== '' && (
                <span>Por: <strong class="font-medium text-gray-900">{authorName}</strong></span>
            )}                

            <span>
                Publicado em
                <time datetime={entry.data.pubDate}>
                    {
                        new Date(entry.data.pubDate).toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: '2-digit',
                        })
                    }
                </time>

                {showUpdatedDate && ' | Atualizado em '}
                {showUpdatedDate && (
                    <time datetime={entry.data.updatedDate}>
                        {
                            new Date(entry.data.updatedDate).toLocaleDateString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit',
                                year: '2-digit',
                            })
                        }
                    </time>
                )}    

            </span>

        </div>

        <!-- Hero Image -->
        {
            entry.data.image && entry.data.image !== '/assets/images/blog/' && (
                <img
                    src={entry.data.image}
                    alt={entry.data.title}
                    class="w-full h-[360px] sm:h-[460px] lg:h-[620px] object-cover mb-24"
                />
            )
        }

        <!-- Article Container with Sidebar -->
        <div class="w-full flex flex-col lg:flex-row gap-12">
            <!-- Main Article Content -->
            <article class="flex-1 min-w-0">
                <!-- Article Content -->
                <div class="blog-content prose prose-lg max-w-none" set:html={processedHtml} />

                {
                    authorName && (
                        <div class="author-section">
                            <div class="author-divider" />
                            <div class="author-card">
                                {authorImageUrl && (
                                    <div class="author-image">
                                        <img src={authorImageUrl} alt={authorName} />
                                    </div>
                                )}
                                <div class="author-content">
                                    <div class="author-info">
                                        <span class="author-label">Escrito por</span>
                                        <h3 class="author-name">{authorName}</h3>
                                    </div>
                                    {authorDescription && (
                                        <p class="author-description">{authorDescription}</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    )
                }

                {
                    faqData && Array.isArray(faqData) && faqData.length > 0 && (
                        <div class="faq-section">
                            <div class="faq-divider" />
                            <div class="faq-card">
                                <h2 class="faq-title">Perguntas Frequentes</h2>
                                <div class="faq-list">
                                    {faqData.map((item, index) => (
                                        <div class="faq-item" key={index}>
                                            <button
                                                class="faq-question"
                                                onclick={`toggleFaq(${index})`}
                                                aria-expanded="false"
                                                aria-controls={`faq-answer-${index}`}
                                            >
                                                <span class="faq-question-text">{item.question}</span>
                                                <svg
                                                    class="faq-chevron"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 9l-7 7-7-7"
                                                    />
                                                </svg>
                                            </button>
                                            <div
                                                class="faq-answer"
                                                id={`faq-answer-${index}`}
                                                style="display: none;"
                                            >
                                                <p>{item.answer}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )
                }

                <div class="disclaimer-section">
                    <div class="disclaimer-card">
                        <div class="disclaimer-content">
                            <p>
                                <strong>Nota:</strong> As informa√ß√µes deste artigo s√£o para fins educativos.
                                Sempre verifique dados atualizados em fontes oficiais antes de tomar decis√µes
                                importantes.
                            </p>
                        </div>
                    </div>
                </div>

            </article>

            <!-- Sidebar -->
            <aside class="w-full lg:w-80 flex-shrink-0">
                <div class="lg:sticky lg:top-24 space-y-8">
                    <SidebarAbove />
                    <div class="toc-responsive">
                        <TableOfContents headings={headings} />
                    </div>
                    {AffiliateAds && <AffiliateAds />}
                </div>
            </aside>

        </div>

        <!-- Related Articles - Full Width -->
        {relatedArticles && relatedArticles.length > 0 && (
            <section class="mt-20 mb-24 w-full">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <!-- T√≠tulo -->
                    <h2 class="text-2xl font-semibold text-slate-900 mb-10">
                        Relacionados
                    </h2>

                    <!-- Grid -->
                    <div class="grid gap-10 grid-cols-[repeat(auto-fit,minmax(260px,1fr))]">
                        {relatedArticles.slice(0, 4).map((article) => {
                            const imageUrl =
                                article.seo_image_url ||
                                (article.image
                                    ? `/assets/images/blog/${article.image.replace(/^.*\//, '')}`
                                    : null);

                            return (
                                <a
                                    href={`/blog/${article.slug}`}
                                    class="flex flex-col no-underline text-left"
                                >
                                    <!-- Imagem -->
                                    <div class="w-full aspect-square bg-slate-100 overflow-hidden mb-4">
                                        {imageUrl ? (
                                            <img
                                                src={imageUrl}
                                                alt={article.title}
                                                loading="lazy"
                                                class="w-full h-full object-cover"
                                            />
                                        ) : (
                                            <div class="w-full h-full flex items-center justify-center text-slate-400">
                                                <svg
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    class="w-8 h-8"
                                                >
                                                    <rect x="3" y="3" width="18" height="18" rx="2" />
                                                    <circle cx="8.5" cy="8.5" r="1.5" />
                                                    <polyline points="21,15 16,10 5,21" />
                                                </svg>
                                            </div>
                                        )}
                                    </div>

                                    <!-- Conte√∫do -->
                                    <div class="flex flex-col">
                                        <h3 class="text-lg font-semibold leading-snug text-slate-900 mb-2">
                                            {article.title}
                                        </h3>

                                        <span class="text-sm text-slate-500">
                                            27 jan 26
                                        </span>

                                        <span class="inline-flex items-center gap-1 text-purple-600 font-medium mt-2">
                                            Ler mais
                                            <svg viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                <path
                                                    fill-rule="evenodd"
                                                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                                    clip-rule="evenodd"
                                                />
                                            </svg>
                                        </span>

                                        {article.blog_topic && (
                                            <div class="mt-4">
                                                <span class="inline-flex px-3 py-1 text-sm rounded-md bg-slate-100 text-slate-700">
                                                    {article.blog_topic.title}
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </a>
                            );
                        })}
                    </div>
                </div>
            </section>
        )}

    </main>

</SharedBlogLayout>

<style is:global>
    @import '/shared.css';
</style>

<script>
    function toggleFaq(index: number) {
        const button = document.querySelector(`button[onclick="toggleFaq(${index})"]`);
        const answer = document.getElementById(`faq-answer-${index}`);

        if (!button || !answer) return;

        const isExpanded = button.getAttribute('aria-expanded') === 'true';

        // Close all other FAQ items
        document.querySelectorAll('.faq-question').forEach((btn, idx) => {
            if (idx !== index) {
                btn.setAttribute('aria-expanded', 'false');
                const otherAnswer = document.getElementById(`faq-answer-${idx}`);
                if (otherAnswer) {
                    otherAnswer.style.display = 'none';
                }
            }
        });

        // Toggle current item
        if (isExpanded) {
            button.setAttribute('aria-expanded', 'false');
            answer.style.display = 'none';
        } else {
            button.setAttribute('aria-expanded', 'true');
            answer.style.display = 'block';
        }
    }

    // Make function globally available
    (window as any).toggleFaq = toggleFaq;

    // Handle image fallbacks for related articles
    function handleImageError(img: HTMLImageElement) {
        img.src = '/assets/images/blog/logo-bg-white-blog.png';
        img.onerror = null; // Prevent infinite loop
    }

    // Set up image error handling after DOM loads
    document.addEventListener('DOMContentLoaded', () => {
        const relatedImages = document.querySelectorAll('.related-article-image img');
        relatedImages.forEach((img) => {
            (img as HTMLImageElement).onerror = function () {
                handleImageError(this as HTMLImageElement);
            };
        });
    });
</script>
