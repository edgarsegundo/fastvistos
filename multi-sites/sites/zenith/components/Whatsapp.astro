---
// Whatsapp Button Component
---

<!-- WhatsApp Button -->
<div class="fixed bottom-5 right-5">
    <button
        class="wpp_button_link bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition duration-300"
        style="background-color: #24CA61;"
        data-linkcode="%231"
    >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 90" class="w-8 h-8">
            <path
                fill="#FFF"
                d="M90 43.841c0 24.213-19.779 43.841-44.182 43.841a44.256 44.256 0 0 1-21.357-5.455L0 90l7.975-23.522a43.38 43.38 0 0 1-6.34-22.637C1.635 19.628 21.416 0 45.818 0 70.223 0 90 19.628 90 43.841zM45.818 6.982c-20.484 0-37.146 16.535-37.146 36.859 0 8.065 2.629 15.534 7.076 21.61L11.107 79.14l14.275-4.537A37.122 37.122 0 0 0 45.819 80.7c20.481 0 37.146-16.533 37.146-36.857S66.301 6.982 45.818 6.982zm22.311 46.956c-.273-.447-.994-.717-2.076-1.254-1.084-.537-6.41-3.138-7.4-3.495-.993-.358-1.717-.538-2.438.537-.721 1.076-2.797 3.495-3.43 4.212-.632.719-1.263.809-2.347.271-1.082-.537-4.571-1.673-8.708-5.333-3.219-2.848-5.393-6.364-6.025-7.441-.631-1.075-.066-1.656.475-2.191.488-.482 1.084-1.255 1.625-1.882.543-.628.723-1.075 1.082-1.793.363-.717.182-1.344-.09-1.883-.27-.537-2.438-5.825-3.34-7.977-.902-2.15-1.803-1.792-2.436-1.792-.631 0-1.354-.09-2.076-.09s-1.896.269-2.889 1.344c-.992 1.076-3.789 3.676-3.789 8.963 0 5.288 3.879 10.397 4.422 11.113.541.716 7.49 11.92 18.5 16.223C58.2 65.771 58.2 64.336 60.186 64.156c1.984-.179 6.406-2.599 7.312-5.107.9-2.512.9-4.663.631-5.111z"
            >
            </path>
        </svg>
    </button>
</div>

<!-- Chat Window -->
<div
    id="whatsapp-popup"
    class="fixed bottom-24 right-5 w-full max-w-xs sm:w-80 bg-white rounded-lg shadow-lg hidden transform translate-y-full transition-transform duration-500 ease-in-out"
>
    <div class="p-4 border-b rounded-t-lg shadow-lg" style="background-color: #018069;">
        <div class="flex items-center">
            <img
                src="assets/images/whatsapp/avatar-dani.webp"
                alt="John Doe"
                class="w-20 h-20 rounded-full"
            />
            <div
                class="absolute top-20 left-20 w-3 h-3 bg-green-500 rounded-full border-2 border-white"
                style="border-color: #028069; background-color: #49D506;"
            >
            </div>

            <div class="ml-3">
                <div class="font-bold">Daniela</div>
                <div class="text-sm text-white">Online</div>
            </div>

            <!-- Close button (X) -->
            <button
                id="close-chat"
                class="absolute top-1 right-3 text-white text-xl focus:outline-none"
            >
                Ã—
            </button>
        </div>
    </div>
    <div class="chat-window rounded-b-lg chat-window" style="background-color: #e5ddd5;">
        <div
            id="chat-time-display"
            class="p-2 text-xs text-gray-100 text-center"
            style="color: #D1CBC4;"
        >
            07:11
        </div>
        <div class="p-4">
            <div class="flex items-start">
                <!-- Message bubble with correct triangle -->
                <div class="ml-2 relative">
                    <!-- Triangle pointing right with base on top -->
                    <div
                        class="absolute left-0 top-0"
                        style="width: 0; height: 0; border-top: 12px solid white; border-left: 12px solid transparent; transform: translateX(-12px);"
                    >
                    </div>
                    <!-- Actual message bubble -->
                    <div
                        class="bg-white text-black p-3 rounded-tr-lg rounded-br-lg rounded-bl-lg shadow-lg"
                    >
                        <div>OlÃ¡ ðŸ‘‹</div>
                        <div>Como posso ajudar?</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 flex justify-center items-center">
            <button
                id="start-chat"
                class="bg-green-500 text-white px-4 py-3 rounded-full shadow-lg hover:bg-green-600 transition duration-300 flex items-center justify-center space-x-2"
                style="background-color: #23D366;"
            >
                <!-- WhatsApp SVG Icon -->
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="#FFFFFF"
                    viewBox="0 0 90 90"
                    class="w-6 h-6"
                >
                    <path
                        d="M90 43.841c0 24.213-19.779 43.841-44.182 43.841a44.256 44.256 0 0 1-21.357-5.455L0 90l7.975-23.522a43.38 43.38 0 0 1-6.34-22.637C1.635 19.628 21.416 0 45.818 0 70.223 0 90 19.628 90 43.841zM45.818 6.982c-20.484 0-37.146 16.535-37.146 36.859 0 8.065 2.629 15.534 7.076 21.61L11.107 79.14l14.275-4.537A37.122 37.122 0 0 0 45.819 80.7c20.481 0 37.146-16.533 37.146-36.857S66.301 6.982 45.818 6.982zm22.311 46.956c-.273-.447-.994-.717-2.076-1.254-1.084-.537-6.41-3.138-7.4-3.495-.993-.358-1.717-.538-2.438.537-.721 1.076-2.797 3.495-3.43 4.212-.632.719-1.263.809-2.347.271-1.082-.537-4.571-1.673-8.708-5.333-3.219-2.848-5.393-6.364-6.025-7.441-.631-1.075-.066-1.656.475-2.191.488-.482 1.084-1.255 1.625-1.882.543-.628.723-1.075 1.082-1.793.363-.717.182-1.344-.09-1.883-.27-.537-2.438-5.825-3.34-7.977-.902-2.15-1.803-1.792-2.436-1.792-.631 0-1.354-.09-2.076-.09s-1.896.269-2.889 1.344c-.992 1.076-3.789 3.676-3.789 8.963 0 5.288 3.879 10.397 4.422 11.113.541.716 7.49 11.92 18.5 16.223C58.2 65.771 58.2 64.336 60.186 64.156c1.984-.179 6.406-2.599 7.312-5.107.9-2.512.9-4.663.631-5.111z"
                    >
                    </path>
                </svg>
                <!-- Button Text -->
                <span class="text-lg" style="color: white !important;">Iniciar Conversa</span>
            </button>
        </div>
    </div>
</div>

<style>
    .chat-window {
        background-image: url('assets/images/whatsapp/background-whatsapp.webp');
        background-size: cover;
        background-position: center;
    }
</style>

<!-- Whatsapp Click Event Handler -->
<script>
    var linkCode = '';

    document.querySelectorAll('.wpp_button_link').forEach((button) => {
        button.addEventListener('click', function (event) {
            event.preventDefault();
            const chatWindow = document.getElementById('whatsapp-popup');
            // %231 = #1 (Default)  : User clicked on the button without specifying what he wants
            // %232 = #2            : User clicked on the button to know more about US visa
            // %233 = #3            : User clicked on the button to know more about Canadian visa
            // %234 = #4            : User clicked on the button to know more about Mexican visa
            // %235 = #5            : User clicked on the button to know more about Passport
            if (event.currentTarget) {
                linkCode = event.currentTarget.getAttribute('data-linkcode');
            } else {
                linkCode = '';
            }
            if (linkCode === null || linkCode === undefined || linkCode === '') {
                // Set the default link code
                linkCode = `%231`;
            }

            // Toggle visibility and slide in/out effect
            if (chatWindow && chatWindow.classList.contains('hidden')) {
                chatWindow.classList.remove('hidden');
                const chatTimeDisplay = document.getElementById('chat-time-display');
                if (chatTimeDisplay) {
                    chatTimeDisplay.innerHTML = new Date().toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit',
                    });
                }

                setTimeout(() => {
                    chatWindow.classList.remove('translate-y-full');
                }, 50); // Small delay to allow the transition to work
            } else if (chatWindow) {
                hidePopup(chatWindow);
            }
        });
    });
    // start chat functionality
    // Don't change this `start-chat` id as it is used by google tag manager to track conversions
    const startChatButton = document.getElementById('start-chat');
    if (startChatButton) {
        startChatButton.addEventListener('click', function () {
            // Push event to GTM dataLayer
            // window.dataLayer = window.dataLayer || [];
            // window.dataLayer.push({
            //     event: 'start-chat-button-click',
            //     category: 'Button Click',
            //     action: 'Start Chat',
            //     label: 'WhatsApp'
            // });

            // Google Analytics 4 event tracking, this was the last I commented
            // gtag('event', 'conversion', {
            //     'send_to': 'AW-17056575506/CIo9CK3z_8IaEJLgmsU_',
            //     'value': 1.0,
            //     'currency': 'BRL'
            // });
            window.open(
                `https://api.whatsapp.com/send?phone=551920422785&text=Ol%C3%A1!%20Gostaria%20de%20saber%20mais%20informa%C3%A7%C3%B5es%20sobre%20os%20servi%C3%A7os%20de%20vistos.${linkCode}`,
                '_blank'
            );
            const popup = document.getElementById('whatsapp-popup');
            if (popup) {
                hidePopup(popup);
            }
        });
    }
    // Fechar popup ao clicar fora
    document.addEventListener('click', function (event) {
        const popup = document.getElementById('whatsapp-popup');
        if (
            popup &&
            event.target &&
            !popup.contains(event.target as Node) &&
            !(event.target as Element).closest('.wpp_button_link')
        ) {
            hidePopup(popup);
        }
    });
    // Close chat functionality
    const closeChatButton = document.getElementById('close-chat');
    if (closeChatButton) {
        closeChatButton.addEventListener('click', function () {
            const popup = document.getElementById('whatsapp-popup');
            if (popup) {
                hidePopup(popup);
            }
        });
    }

    function hidePopup(popup: HTMLElement) {
        popup.classList.add('translate-y-full');
        popup.classList.add('hidden');
    }
</script>
