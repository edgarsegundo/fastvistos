---
/**
 * üö® AUTO-GENERATED FILE. DO NOT EDIT.
 * This file is generated by sync-blog.js and will be overwritten.
 * To customize, edit the template.
 */

import { getCollection } from 'astro:content';
import SharedBlogLayout from '../../layouts/SharedBlogLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import SidebarAbove from '../../components/SidebarAbove.astro';
import SidebarBelow from '../../components/SidebarBelow.astro';
import AffiliateAds from '../../components/AffiliateAds.astro';
import { siteConfig } from '../../site-config.ts';
import { BlogService } from '../../lib/blog-service.ts';
import { RelatedArticlesService } from '../../lib/related-articles.ts';
import { ContentProcessor } from '../../lib/content-processor.ts';
import { estimateReadingTime, getValidatedImageUrl } from '../../lib/utils.ts';
import JsonLdBlogPost from '../../components/JsonLdBlogPost.astro';
import { marked } from 'marked';
import '../../styles/markdown-blog.css';
import { ensureTrailingSlash } from '../../lib/utils.ts';


// Generate static paths from the markdown files in content/blog/
export async function getStaticPaths() {
    const blogEntries = await getCollection('blog');

    return blogEntries.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

// Get the markdown entry from props
const { entry } = Astro.props;

// Process HowTo tags first, then RELATED-ARTICLE tags
const rawContent = entry.body || '';
const { processedContent: contentNoHowTo, howToJson } =
    ContentProcessor.processHowToTags(rawContent);
const processedContent = await ContentProcessor.processRelatedArticleTags(contentNoHowTo);

console.log(`üõëüõë howToJson: ${JSON.stringify(howToJson)}`);

// Render the original content for headings (TOC)
const { headings } = await entry.render();

// Convert processed markdown to HTML
let processedHtml = await marked(processedContent, {
    gfm: true,
    breaks: true,
});

processedHtml = await ContentProcessor.addHeadingIds(processedHtml);

const articleFromDb = await BlogService.getArticleBySlugFromDb(entry.slug);
const blogConfigFromDb = await BlogService.getBlogConfigFromDb();
const canonical = siteConfig.site.canonical
    ? new URL(ensureTrailingSlash(siteConfig.site.canonical) + 'blog/' + entry.slug).toString()
    : undefined;

// Get author information
const authorName = articleFromDb?.author_name || blogConfigFromDb?.author_name;
const authorImage = articleFromDb?.author_image || blogConfigFromDb?.author_image;
const authorDescription = blogConfigFromDb?.author_description;

// Get FAQ information
const faqJson = articleFromDb?.faq_json;
let faqData = null;

if (faqJson) {
    try {
        faqData = typeof faqJson === 'string' ? JSON.parse(faqJson) : faqJson;
    } catch (e) {
        console.error('Error parsing FAQ JSON:', e);
    }
}

// Get related articles
let relatedArticles = [];
if (articleFromDb?.id) {
    try {
        relatedArticles = await RelatedArticlesService.getRelatedArticlesSimple(articleFromDb.id);
        console.log(`üìö Found ${relatedArticles.length} related articles`);
    } catch (e) {
        console.error('Error fetching related articles:', e);
    }
}

const authorImageUrl = authorImage
    ? '/assets/images/blog/' + authorImage.replace(/^.*\//, '')
    : null;


// No topo do script, ap√≥s const { entry } = Astro.props;
const pubDate = new Date(entry.data.pubDate);
pubDate.setHours(0, 0, 0, 0);

const updatedDate = entry.data.updatedDate ? new Date(entry.data.updatedDate) : null;
if (updatedDate) updatedDate.setHours(0, 0, 0, 0);

const showUpdatedDate = updatedDate && updatedDate > pubDate;

---

<SharedBlogLayout
    canonicalConf={canonical}
    faviconPathFromConf={siteConfig.site.faviconPath}
    seoFromConf={siteConfig.blogPostConfig.seo}
    titleFromDb={articleFromDb?.title}
    descriptionFromDb={articleFromDb?.seo_description}
    authorNameFromDb={articleFromDb?.author_name}
    imageFromDb={articleFromDb?.image}
    imageUrlFromDb={articleFromDb?.seo_image_url}
    imageCaptionFromDb={articleFromDb?.seo_image_caption}
    imageWidthFromDb={articleFromDb?.seo_image_width}
    imageHeightFromDb={articleFromDb?.seo_image_height}
    pubDate={articleFromDb?.published ? new Date(articleFromDb.published).toISOString() : undefined}
    updatedDate={articleFromDb?.modified
        ? new Date(articleFromDb.modified).toISOString()
        : undefined}
>
    
    <Fragment slot="head">
        
        <JsonLdBlogPost
            articleConfigFromDb={articleFromDb}
            blogConfigFromDb={blogConfigFromDb}
            pubDate={entry.data.pubDate}
            updatedDate={entry.data.updatedDate}
            wordCount={entry.data.wordCount}
            howToLdJson={howToJson}
        />
    </Fragment>

    
    <main class="w-full px-4 sm:px-6 lg:px-42 pt-12 mt-16">

        
        <nav class="text-sm text-textSecondary mb-6">
            <span>
                <a
                    href={siteConfig.site.canonical}
                    class=""
                    >Home</a
                >                
            </span>
            <span class="mx-2">‚Ä∫</span>
            <span>
                <a
                    href="/blog"
                    class=""
                    >Blog</a
                >
            </span>
            <span class="mx-2">‚Ä∫</span>
            <span class="font-small text-[#6b6f76] opacity-80">
                {entry.data.title}
            </span>
        </nav>

        
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-semibold leading-tight mb-8 max-w-5xl">
            {entry.data.title}
        </h1>

        
        <p class="text-lg sm:text-xl text-textSecondary mb-10 max-w-3xl">
            {entry.data.description && entry.data.description}
        </p>

        
        <span class="inline-block text-sm font-medium mb-10">
            {entry.data.topic && <span class="article-topic">{entry.data.topic}</span>}
        </span>

        
        <div class="flex flex-wrap items-center gap-4 text-sm text-textSecondary mb-12">
            <div class="flex items-center gap-1">
                <span>‚è±</span>
                <span>{estimateReadingTime(Number(entry.data.wordCount))} minutos de leitura</span>
            </div>
            <span>Por: <strong class="font-medium text-gray-900">Mariana Neves</strong></span>

            <span>
                Publicado em
                <time datetime={entry.data.pubDate}>
                    {
                        new Date(entry.data.pubDate).toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: '2-digit',
                        })
                    }
                </time>

                {showUpdatedDate && ' | Atualizado em '}
                {showUpdatedDate && (
                    <time datetime={entry.data.updatedDate}>
                        {
                            new Date(entry.data.updatedDate).toLocaleDateString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit',
                                year: '2-digit',
                            })
                        }
                    </time>
                )}    

            </span>

        </div>

        
        {
            entry.data.image && entry.data.image !== '/assets/images/blog/' && (
                <img
                    src={entry.data.image}
                    alt={entry.data.title}
                    class="w-full h-[360px] sm:h-[460px] lg:h-[620px] object-cover mb-24"
                />
            )
        }

        
        <div class="w-full flex flex-col lg:flex-row gap-12">
            
            <article class="flex-1 min-w-0">
                
                <div class="blog-content prose prose-lg max-w-none" set:html={processedHtml} />

                
                {/* Seu FAQ aqui */}

                
                {/* Seu Author aqui */}

                
                {/* Seus artigos relacionados aqui */}
            </article>

            
            <aside class="w-full lg:w-80 flex-shrink-0">
                <div class="lg:sticky lg:top-24 space-y-8">
                    
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="font-semibold text-lg mb-4">Neste artigo</h3>
                        {/* Seu TOC aqui */}
                    </div>

                    
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="font-semibold text-lg mb-4">Publicidade</h3>
                        {/* Suas propagandas aqui */}
                    </div>
                </div>
            </aside>
        </div>

    </main>

</SharedBlogLayout>

<style is:global>
    @import '/shared.css';
</style>

