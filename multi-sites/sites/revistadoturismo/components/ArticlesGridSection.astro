---
import ResponsiveImage from "./ResponsiveImage.astro";
import map from "../generated-image-map.json";

import article1 from '../../../../public-sites/revistadoturismo/assets/images-base/article1.jpg';
import article2 from '../../../../public-sites/revistadoturismo/assets/images-base/article2.jpg';
import article3 from '../../../../public-sites/revistadoturismo/assets/images-base/article3.jpg';

import { siteConfig } from '../site-config.ts';

const siteId = siteConfig.site.id;

const imageBase = `/public-sites/${siteId}/assets/images-base/resized/`;


/*
| Tipo de leeway      | px       | Quando usar                                |
| ------------------- | -------- | ------------------------------------------ |
| conservador         | 10px     | Máxima nitidez, economia moderada          |
| ideal ⭐            | 15px     | Melhor equilíbrio entre nitidez e economia |
| agressivo           | 20px     | Mais economia, sem perda perceptível       |
| limite seguro       | 25px     | Máximo tolerável sem blur visível          |
| não recomendado     | 30px+    | Pode ficar levemente borrado               |

Observação importante:
Aplicamos o leeway *somente nos dois primeiros breakpoints* porque esses são os únicos
que representam o mesmo layout (1 card) variando pixel a pixel conforme o viewport muda.
Ou seja, o tamanho real do card cresce ou encolhe suavemente, então vale a pena dar 
uma margem para evitar trocar de imagem por diferenças de 1–5 px.

Já os breakpoints seguintes não recebem leeway porque representam mudanças bruscas 
de layout (1 → 2 cards, 2 → 3 cards). Nessas transições há saltos grandes no tamanho 
dos cards, portanto usar leeway poderia escolher tamanhos errados e prejudicar a nitidez.
*/

// Ajuste aqui o leeway desejado:
const LEEWAY = 15;

// Refactoring: aplicar LEEWAY *apenas* nos 2 primeiros breakpoints
const sizes = `
  (max-width: ${388 + LEEWAY}px) 356px,
  (max-width: ${517 + LEEWAY}px) 485px,
  (max-width: 767px) 608px,
  (max-width: 1279px) 356px,
  485px
`;


const cards = [
  {
    key: "article1",
    img: article1,
    alt: "Restaurantes con vistas espectaculares",
    title: "Los 10 restaurantes con las vistas más espectaculares del mundo",
    desc: "Desde acantilados até rascacielos, estos restaurantes ofrecen experiencias culinárias inolvidables.",
    category: "Gastronomía",
    time: "Hace 2 horas",
  },
  {
    key: "article2",
    img: article2,
    alt: "Artigo 2",
    title: "Playas paradisíacas que deberías visitar este verano",
    desc: "Arenas blancas, aguas turquesas y paisajes tropicales te esperan.",
    category: "Naturaleza",
    time: "Hace 5 horas",
  },
  {
    key: "article3",
    img: article3,
    alt: "Artigo 3",
    title: "Tokyo en 3 días: guía definitiva",
    desc: "Aprovecha al máximo tu visita con esta ruta cuidadosamente planificada.",
    category: "Viajes urbanos",
    time: "Hace 1 día",
  },
];

function buildSrcSet(key, type) {
  const files = map[key][type];

  const filtered = files.filter(f =>
    f.includes("-356-1x") || f.includes("-356-2x") ||
    f.includes("-485-1x") || f.includes("-485-2x") ||
    f.includes("-608-1x") || f.includes("-608-2x")
  );

  return filtered.map(f => imageBase + f).join(", ");
}
---

<section class="container mx-auto px-4 py-8">
  <h2 class="text-2xl font-bold mb-6">Últimos artículos</h2>

  <div id="viewport-label" class="mb-4 text-sm text-gray-700 font-mono"></div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

    {cards.map((card, i) => (
      <article class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition-shadow">

        <div class="aspect-[3/2] relative">
          <span class="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded z-10 wxh-label"></span>

          <ResponsiveImage
            alt={card.alt}
            width={608}
            height={405}
            sizes={sizes}
            sources={{
              webp: buildSrcSet(card.key, "webp"),
              jpeg: buildSrcSet(card.key, "jpeg")
            }}
            blurDataURL={map[card.key].blurDataURL}
            priority={i === 0}
          />
        </div>

        <div class="p-4">
          <h3 class="font-bold text-lg mb-2 line-clamp-2">{card.title}</h3>
          <p class="text-gray-600 text-sm mb-3 line-clamp-3">{card.desc}</p>
          <div class="flex items-center justify-between text-xs text-gray-500">
            <span>{card.category}</span>
            <span>{card.time}</span>
          </div>
        </div>

      </article>
    ))}

  </div>
</section>

<script>
function updateWxHLabels() {
  const viewportLabel = document.getElementById('viewport-label');
  if (viewportLabel) {
    viewportLabel.textContent = 'Viewport: ' + window.innerWidth + ' x ' + window.innerHeight;
  }

  document.querySelectorAll('[class*="aspect-"]').forEach(card => {
    const rect = card.getBoundingClientRect();
    const label = card.querySelector('.wxh-label');
    if (label) {
      label.textContent = `${Math.round(rect.width)} x ${Math.round(rect.height)}`;
    }
  });
}

let resizeTimeout;
function debouncedUpdate() {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(updateWxHLabels, 50);
}

window.addEventListener('load', updateWxHLabels);
window.addEventListener('resize', debouncedUpdate);
</script>
