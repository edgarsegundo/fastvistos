---
import SharedGenericLayout from '../layouts/SharedGenericLayout.astro';
import Navigation from '../components/Navigation.astro';
import { siteConfig } from '../site-config.ts';

const { bodyClass = '', bodyStyle = '' } = Astro.props;

const pageTitle = "Buscar Candidatos - " + siteConfig.site.name;
---

<SharedGenericLayout
    bodyClass={`${bodyClass} leading-normal tracking-normal text-white antialiased`}
    bodyStyle={`${bodyStyle} font-family: 'Source Sans Pro', sans-serif;`}
    themeToggleDisable={true} // New prop to control theme toggle visibility
    canonicalConf={siteConfig.site.canonical}
    faviconPathFromConf={siteConfig.site.faviconPath}
    seoFromConf={siteConfig.searchPageConfig.seo}
    titleFromConf={siteConfig.searchPageConfig.seo.title}
    descriptionFromConf={siteConfig.searchPageConfig.seo.description}
    authorNameFromConf={siteConfig.site.authorName}
    imageFromConf={null}
    imageUrlFromConf={siteConfig.site.primaryImage.url}
    imageCaptionFromConf={siteConfig.site.primaryImage.imageCaption}
    imageWidthFromConf={siteConfig.site.primaryImage.imageWidth}
    imageHeightFromConf={siteConfig.site.primaryImage.imageHeight}
>
    <Navigation slot="header" />
    
    <main class="min-h-screen bg-gradient-to-b from-gray-50 to-white py-12 px-4">
        <div class="max-w-4xl mx-auto">
            <!-- Search Box -->
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-800 mb-8">Encontre Candidatos</h1>
                
                <div class="flex items-center gap-3 max-w-2xl mx-auto">
                    <div class="relative flex-1">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Digite nome, habilidade ou cargo..."
                            class="w-full py-4 px-6 pr-12 rounded-full text-gray-800 bg-white shadow-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 hover:shadow-xl"
                        />
                        <svg class="absolute right-4 top-1/2 transform -translate-y-1/2 w-6 h-6 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <button
                        id="searchButton"
                        class="px-8 py-4 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-semibold rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    >
                        Buscar
                    </button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="text-gray-600 mt-4">Buscando candidatos...</p>
            </div>

            <!-- Results Container -->
            <div id="resultsContainer" class="space-y-4"></div>

            <!-- Load More Indicator -->
            <div id="loadMoreIndicator" class="hidden text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="hidden text-center py-12">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-gray-600 text-lg">Nenhum candidato encontrado</p>
            </div>
        </div>
    </main>
</SharedGenericLayout>

<script>
    // State management
    let currentPage = 0;
    const pageSize = 10;
    let isLoading = false;
    let hasMoreResults = true;
    let currentSearchQuery = '';

    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const searchButton = document.getElementById('searchButton') as HTMLButtonElement;
    const loadingSpinner = document.getElementById('loadingSpinner') as HTMLDivElement;
    const resultsContainer = document.getElementById('resultsContainer') as HTMLDivElement;
    const loadMoreIndicator = document.getElementById('loadMoreIndicator') as HTMLDivElement;
    const noResults = document.getElementById('noResults') as HTMLDivElement;

    // Fetch candidates from API
    async function fetchCandidates(query: string, offset: number = 0, limit: number = pageSize) {
        try {
            const url = `http://127.0.0.1:8000/api/candidates/?query=${encodeURIComponent(query)}&offset=${offset}&limit=${limit}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error('Falha ao buscar candidatos');
            }
            
            const data = await response.json();
            return data.results || data; // Adaptável para diferentes formatos de resposta
        } catch (error) {
            console.error('Erro ao buscar candidatos:', error);
            return [];
        }
    }

    // Render candidate card
    function renderCandidateCard(candidate: any) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-blue-200 transform hover:-translate-y-1';
        
        card.innerHTML = `
            <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                        ${(candidate.name || candidate.first_name || 'C')[0].toUpperCase()}
                    </div>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">
                        ${candidate.name || candidate.first_name + ' ' + (candidate.last_name || '')}
                    </h3>
                    <p class="text-gray-600 mb-3">
                        ${candidate.description || candidate.bio || 'Profissional qualificado em busca de novas oportunidades. Experiência comprovada e habilidades diversificadas.'}
                    </p>
                    <div class="flex gap-2 flex-wrap">
                        ${candidate.skills ? candidate.skills.split(',').slice(0, 3).map((skill: string) => `
                            <span class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm font-medium">
                                ${skill.trim()}
                            </span>
                        `).join('') : ''}
                    </div>
                </div>
            </div>
        `;
        
        return card;
    }

    // Perform search
    async function performSearch(loadMore: boolean = false) {
        if (isLoading) return;
        
        const query = searchInput.value.trim();
        
        if (!loadMore) {
            // New search
            currentPage = 0;
            currentSearchQuery = query;
            resultsContainer.innerHTML = '';
            hasMoreResults = true;
            noResults.classList.add('hidden');
        }
        
        if (!hasMoreResults) return;
        
        isLoading = true;
        
        if (loadMore) {
            loadMoreIndicator.classList.remove('hidden');
        } else {
            loadingSpinner.classList.remove('hidden');
        }
        
        const offset = currentPage * pageSize;
        const candidates = await fetchCandidates(currentSearchQuery, offset, pageSize);
        
        isLoading = false;
        loadingSpinner.classList.add('hidden');
        loadMoreIndicator.classList.add('hidden');
        
        if (candidates.length === 0) {
            if (currentPage === 0) {
                noResults.classList.remove('hidden');
            }
            hasMoreResults = false;
            return;
        }
        
        // Render results
        candidates.forEach((candidate: any) => {
            const card = renderCandidateCard(candidate);
            resultsContainer.appendChild(card);
        });
        
        currentPage++;
        
        // Check if we got fewer results than requested (means we're at the end)
        if (candidates.length < pageSize) {
            hasMoreResults = false;
        }
    }

    // Infinite scroll handler
    function handleScroll() {
        const scrollPosition = window.innerHeight + window.scrollY;
        const pageHeight = document.documentElement.scrollHeight;
        
        // Load more when user is 300px from bottom
        if (scrollPosition >= pageHeight - 300 && !isLoading && hasMoreResults) {
            performSearch(true);
        }
    }

    // Event listeners
    searchButton.addEventListener('click', () => performSearch(false));
    
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            performSearch(false);
        }
    });
    
    // Throttled scroll listener for performance
    let scrollTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(handleScroll, 100);
    });

    // Initial focus
    searchInput.focus();
</script>