---
/**
 * JsonLdBlogIndex.astro
 * Dynamically generates JSON-LD for the blog index page using live data from BlogService.
 * - Uses siteConfig for domain and organization info
 * - Uses BlogService.getTopicsWithArticles() for topics and articles
 * - Outputs a <script type="application/ld+json"> in the head
 *
 * This component is generic and will be copied to each site's components/ folder.
 */
import { siteConfig } from '../site-config.ts';
import { BlogService } from '../lib/blog-service.ts';

const topicsWithArticles = await BlogService.getTopicsWithArticles();
const domain = siteConfig.site.domain.startsWith('http') ? siteConfig.site.domain : `https://${siteConfig.site.domain}`;
const orgId = `${domain}/#organization`;
const websiteId = `${domain}/#website`;
const pageId = `${domain}/blog/#webpage`;

const itemLists = topicsWithArticles.map((topic: any) => ({
  "@type": "ItemList",
  "name": topic.title,
  "itemListElement": topic.blog_article.map((article: any, idx: number) => ({
    "@type": "ListItem",
    "position": idx + 1,
    "item": {
      "@type": "BlogPosting",
      "@id": `${domain}/blog/${article.slug}`,
      "headline": article.title,
      "url": `${domain}/blog/${article.slug}`,
      "image": article.image ? `${domain}/assets/images/blog/${article.image.replace(/^.*\//, '')}` : undefined,
      "datePublished": article.published,
      "dateModified": article.updated || article.published,
      "inLanguage": "pt-BR",
      "description": article.description || '',
    }
  }))
}));

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": ["WebPage", "CollectionPage"],
      "@id": pageId,
      "url": `${domain}/blog/`,
      "name": `Blog - ${siteConfig.site.name}`,
      "isPartOf": { "@id": websiteId },
      "description": siteConfig.blogPageConfig.seo.description || '',
      "inLanguage": "pt-BR",
      "publisher": { "@id": orgId },
      "hasPart": itemLists
    },
    {
      "@type": "WebSite",
      "@id": websiteId,
      "url": domain + '/',
      "name": siteConfig.site.name,
      "description": siteConfig.site.description || '',
      "publisher": { "@id": orgId },
      "inLanguage": "pt-BR"
    },
    {
      "@type": "Organization",
      "@id": orgId,
      "name": siteConfig.site.name,
      "url": domain + '/',
      "logo": {
        "@type": "ImageObject",
        "url": siteConfig.site.logo
      }
    }
  ]
};
---
<script type="application/ld+json" set:html={JSON.stringify(jsonLd, null, 2)} />