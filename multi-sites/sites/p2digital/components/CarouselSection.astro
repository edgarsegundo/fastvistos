---
/**
 * CarouselSection.astro
 * Dynamic carousel for topics and articles
 * Usage: <CarouselSection topicsWithArticles={topicsWithArticles} />
 */

import { BlogService } from "../lib/blog-service.ts";

// Fetch topics with articles dynamically
const topicsWithArticles = await BlogService.getTopicsWithArticles();
---

<style>
  .carousel-container::-webkit-scrollbar { display: none; }
  .carousel-container { -ms-overflow-style: none; scrollbar-width: none; scroll-behavior: smooth; }
  .arrow-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.55);
    width: 42px;
    height: 42px;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 22px;
    backdrop-filter: blur(4px);
    transition: background 0.2s;
    z-index: 20;
  }
  .arrow-btn:hover { background: rgba(0,0,0,0.75); }
  .arrow-left { left: -14px; }
  .arrow-right { right: -14px; }
</style>

<section class="w-full">
  {
    topicsWithArticles.length > 0 ? (
      topicsWithArticles.map((topic) => (
        <div class="relative mt-12 w-full">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 id={topic.slug || topic.id} class="text-3xl font-semibold mb-8 text-black">
              {topic.title}
            </h2>

            <div class="relative pt-8">
              <button class="arrow-btn arrow-left" onclick={`document.querySelector('#carousel-${topic.slug || topic.id}').scrollBy({left:-320, behavior:'smooth'})`}>
                &#10094;
              </button>
              <button class="arrow-btn arrow-right" onclick={`document.querySelector('#carousel-${topic.slug || topic.id}').scrollBy({left:320, behavior:'smooth'})`}>
                &#10095;
              </button>
              <div
                id={`carousel-${topic.slug || topic.id}`}
                class="carousel-container flex gap-6 overflow-x-auto pb-4 pt-4 px-4"
              >
                {topic.blog_article.map((article) => (
                  <a href={`/blog/${article.slug}`}
                  
                     class="bg-white xxxborder xxxborder-gray-200 xxxhover:border-blue-500 transition-all duration-300 flex-shrink-0 w-80 shadow-none xxxhover:shadow-md hover:scale-105 rounded-none cursor-pointer block"
                     style="text-decoration: none;"
                  >
                    <img
                      src={
                        article.image
                          ? `/assets/images/blog/${article.image.replace(/^.*\//, "")}`
                          : "https://via.placeholder.com/400x250"
                      }
                      alt={article.slug || article.title}
                      class="w-full aspect-[1.7] object-cover"
                    />

                    <div class="p-6">
                      <h3 class="text-xl font-semibold mb-2 text-black">
                        {article.title.length > 70
                          ? article.title.slice(0, 70) + "..."
                          : article.title}
                      </h3>

                      <p class="text-gray-600 mb-4">
                        {article.content_html
                          ? article.content_html.replace(/<[^>]*>/g, "").slice(0, 150) + "..."
                          : ""}
                      </p>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>
      ))
    ) : (
      <div class="text-center py-12">
        <p class="text-gray-600 text-lg">Nenhum artigo encontrado.</p>
        <p class="text-gray-500 mt-2">Volte em breve para conferir nossos artigos!</p>
      </div>
    )
  }

  <script>
    const carousels = document.querySelectorAll('.carousel-container');
    const scrollAmount = 320;

    carousels.forEach((carousel) => {
      document.addEventListener('keydown', (e) => {
        const rect = carousel.getBoundingClientRect();
        const isInView = rect.top >= 0 && rect.bottom <= window.innerHeight;

        if (isInView) {
          if (e.key === 'ArrowLeft') {
            carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
          } else if (e.key === 'ArrowRight') {
            carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
          }
        }
      });

      let startX = 0;
      let scrollStart = 0;

      carousel.addEventListener('touchstart', (e) => {
        const touchEvent = e as TouchEvent;
        startX = touchEvent.touches[0].clientX;
        scrollStart = carousel.scrollLeft;
      });

      carousel.addEventListener('touchmove', (e) => {
        const touchEvent = e as TouchEvent;
        if (!startX) return;
        const currentX = touchEvent.touches[0].clientX;
        const diff = startX - currentX;
        carousel.scrollLeft = scrollStart + diff;
      });

      carousel.addEventListener('touchend', () => {
        startX = 0;
        scrollStart = 0;
      });
    });
  </script>
</section>
