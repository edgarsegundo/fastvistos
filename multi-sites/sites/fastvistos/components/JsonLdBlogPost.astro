---
/**
 * JsonLdBlogPost.astro
 * Gera JSON-LD para um BlogPosting (artigo/post), extens√≠vel com mentions, interactionStatistic, comment, etc.
 */
import { ensureTrailingSlash } from '../lib/utils.ts';
import { getImageObjectBlock } from './JsonLdImageObjectBlock.astro';
import { getWebSiteBlock } from './JsonLdWebSiteBlock.astro';
import { getWebPageBlock } from './JsonLdWebPageBlock.astro';
import { getBreadcrumbBlock } from './JsonLdBreadcrumbBlock.astro';
import { getPersonBlock } from './JsonLdPersonBlock.astro';
import { slugify, toThumbnailUrl } from '../lib/utils.ts';
import { siteConfig } from '../site-config.ts';

const {
    articleConfigFromDb,
    pubDate,
    updatedDate,
    wordCount,
    mentions = [],
    interactionStatistic = [],
    comment = [],
    extraGraph = [],
    customData,
} = Astro.props;

const canonicalValidated = ensureTrailingSlash(siteConfig.site.canonical);
const postpageUrl = `${canonicalValidated}blog/${articleConfigFromDb.slug}/`;
const authorName = articleConfigFromDb.author_name || articleConfigFromDb.author_name || siteConfig.site?.authorName || siteConfig.site?.siteName;
const authorNameSlug = slugify(authorName);

const breadcrumbList = [
    {
        '@type': 'ListItem',
        position: 1,
        name: 'Home',
        item: canonicalValidated,
    },
    {
        '@type': 'ListItem',
        position: 2,
        name: 'Blog',
        item: `${canonicalValidated}blog/`,
    },
    {
        '@type': 'ListItem',
        position: 3,
        name: articleConfigFromDb.title,
        item: postpageUrl,
    },
];

const imageObjectBlock = getImageObjectBlock({
    disableImageObject: false,
    imageId: `${postpageUrl}#image`,
    image: articleConfigFromDb.image,
    imageUrl: articleConfigFromDb.seo_image_url,
    caption: articleConfigFromDb.seo_image_caption,
    width: articleConfigFromDb.seo_image_width,
    height: articleConfigFromDb.seo_image_height,
});

const websiteId = `${canonicalValidated}#website`;
const orgId = `${canonicalValidated}#organization`;

// WebPage block
const webPageBlock = getWebPageBlock({
    disableWebPage: false,
    pageUrl: postpageUrl,
    siteName: articleConfigFromDb.title || siteConfig.site?.siteName,
    websiteId,
    orgId,
    imageId: `${postpageUrl}#image`,
    breadcrumbId: `${postpageUrl}#breadcrumb`,
    description: articleConfigFromDb.seo_description,
    pubDate,
    updatedDate,
});

const breadcrumbId = `${postpageUrl}#breadcrumb`;

// BreadcrumbList
const breadcrumbBlock = getBreadcrumbBlock({
    disableBreadcrumb: false,
    breadcrumbId,
    breadcrumbList,
    canonical: canonicalValidated,
});

// WebSite
const webSiteBlock = getWebSiteBlock({
    disableWebSite: false,
    disableWebSiteSearchAction: true,
    websiteId,
    canonical: canonicalValidated,
    siteName: siteConfig.site?.siteName,
    description: siteConfig.homePageConfig.seo.description,
    orgId,
});

const logoId = `${canonicalValidated}#logo`;

// --- Unified Organization + LocalBusiness block
const orgBlock = {
  '@type': 'Organization',
  '@id': orgId,
  name: siteConfig.site?.siteName,
  url: canonicalValidated,
  inLanguage: siteConfig.site.locale || 'pt_BR',
  description: siteConfig.homePageConfig.seo.description,
  logo: {
    '@type': 'ImageObject',
    inLanguage: siteConfig.site.locale || 'pt_BR',
    '@id': logoId,
    url: siteConfig.site?.logo?.url,
    contentUrl: siteConfig.site?.logo?.url,
    ...(siteConfig.site?.logo?.width ? { width: siteConfig.site.logo.width } : {}),
    ...(siteConfig.site?.logo?.height ? { height: siteConfig.site.logo.height } : {}),
    ...(siteConfig.site?.logo?.alt ? { caption: siteConfig.site.logo.alt } : {}),
  },
  image: { '@id': logoId },
};

// 'https://fastvistos.com.br/schema/person/edgar-bola-segundo',
const personBlock = getPersonBlock({
    id: `${canonicalValidated}schema/person/${authorNameSlug}`,
    name: authorName,
    url: `${canonicalValidated}schema/person/${authorNameSlug}`,
});

// https://fastvistos.com.br/#/schema/person/maria-oliveira
const baseGraph = [
    {
        '@type': 'BlogPosting', // or Article?
        '@id': `${postpageUrl}#article`,
        isPartOf: { '@id': `${postpageUrl}` },
        author: {
            '@id': `${canonicalValidated}schema/person/${authorNameSlug}`,
            url: `${canonicalValidated}schema/person/${authorNameSlug}`,
            name: authorName,
        },
        headline: articleConfigFromDb.title,
        description: articleConfigFromDb.seo_description,
        datePublished: pubDate,
        dateModified: updatedDate,
        mainEntityOfPage: { '@id': `${postpageUrl}` },
        wordCount: parseInt(wordCount),
        publisher: { '@id': `${canonicalValidated}#organization` },
        image: { '@id': `${postpageUrl}#image` },
        primaryImageOfPage: { '@id': `${postpageUrl}#image` },
        ...(imageObjectBlock?.url ? { thumbnailUrl: toThumbnailUrl(imageObjectBlock.url) } : {}),
        articleSection: [`${articleConfigFromDb.blog_topic.title}`],
        inLanguage: siteConfig.site?.locale || 'pt_BR',
    },
    {
        ...webPageBlock,
    },
    {
        ...imageObjectBlock,
    },
    {
        ...breadcrumbBlock,
    },
    {
        ...webSiteBlock,
    },
    {
        ...orgBlock,
    },
    {
        ...personBlock,
    },
];
const advancedGraph = [
    ...(mentions.length ? [{ mentions: mentions }] : []),
    ...(interactionStatistic.length ? [{ interactionStatistic: interactionStatistic }] : []),
    ...(comment.length ? [{ comment: comment }] : []),
    ...extraGraph,
];
const graph = [...baseGraph, ...advancedGraph];
const jsonLd = customData ? customData : { '@context': 'https://schema.org', '@graph': graph };
---

<script type="application/ld+json" set:html={JSON.stringify(jsonLd, null, 2)} />
